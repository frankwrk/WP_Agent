#!/usr/bin/env bash
set -euo pipefail

PATTERN='api\.synqengine\.com|46\.224\.9\.81|/etc/synq|synqsvc|synqengine|x-wp-agent-bootstrap|installation_id:|BACKEND_SIGNING_PRIVATE_KEY|PAIRING_BOOTSTRAP_SECRET|supabase-ca\.pem'

files=()
while IFS= read -r f; do
  if [ -f "$f" ]; then
    files+=("$f")
  fi
done <<EOF
$( {
  git diff --name-only --cached
  git diff --name-only
} | sort -u | rg -N '^(README\.md|docs/.*\.md|AGENTS\.md|ROADMAP\.md|SECURITY\.md|DOCS_CLASSIFICATION\.md)$' || true )
EOF

if [ "${#files[@]}" -eq 0 ]; then
  exit 0
fi

if rg -n --color=never -e "$PATTERN" "${files[@]}"; then
  echo "Blocked push: sensitive documentation pattern detected." >&2
  echo "Redact the match or move details to the private docs repository." >&2
  exit 1
fi
